---
title: "Pharmacy In Practice"
author: "David Fong"
date: "30/08/2020"
output:
  bookdown::html_document2:
    toc: true
    toc_float: true
    toc_depth: 2
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r warning=FALSE, message=FALSE}
library(readxl)    # read Excel spreadsheets (with gritted teeth...)
library(magrittr)
library(dplyr)     # data pliers
library(tidyr)
library(lubridate)
library(ggplot2)   # plotting
library(cowplot)   # side-by-side plot
library(lme4)      # glmer
```

# Sources of measurement

* The active patient list
  + generated by [dMeasure/GPstat!](https://github.com/DavidPatShuiFong/DailyMeasure)
  + Patients billed on three or more separate days between *2017-10-01* and *2019-09-30* inclusive
* The dated list of billings for patient in the 'active' list
  + generated by [dMeasure/GPstat!](https://github.com/DavidPatShuiFong/DailyMeasure)
* List of telephone and 'in-person (in surgery)' contact by the pharmacist with patients
  + generated by [dMeasure/GPstat!](https://github.com/DavidPatShuiFong/DailyMeasure)
* Medication counts of Kensington pateints *2019-12-01* and *2020-08-01*
  + generated by [PenCS CAT4](https:://www.pencs.com.au)

```{r}
### read in data

active_patient <- read.csv("active_patient.csv")
active_patient_billings <- read.csv("active_patient_billings.csv")
pharmacist_contacts <- read.csv("LauraDeanVisits.csv")

# change various numericals into 'categoricals'
active_patient <- active_patient %>%
  mutate(
    InternalID = factor(InternalID)
  )

# also change some date 'strings' to true 'dates'
active_patient_billings <- active_patient_billings %>%
  mutate(
    InternalID = factor(InternalID),
    MBSItem = factor(MBSItem),
    ServiceDate = as.Date(ServiceDate)
  )
# these are not truly numeric values, they are actually 'categoricals'

pharmacist_contacts <- pharmacist_contacts %>%
  mutate(
    InternalID = factor(InternalID),
    VisitType = factor(VisitType),
    VisitDate = as.Date(VisitDate)
  )

medication_count <- list()
medication_count[[1]] <- read_excel(
  "PenCSMedicationCount20191201.xlsx", sheet = "ReidentifyReport",
  skip = 3) %>%
  select(ID, `Med. Count`) %>%
  rename(InternalID = ID, MedCount = `Med. Count`) %>%
  mutate(InternalID = factor(InternalID), MedCount = as.numeric(MedCount))
medication_count[[2]] <- read_excel(
  "PenCSMedicationCount20200801.xlsx", sheet = "ReidentifyReport",
  skip = 3) %>%
  select(ID, `Med. Count`) %>%
  rename(InternalID = ID, MedCount = `Med. Count`) %>%
  mutate(InternalID = factor(InternalID), MedCount = as.numeric(MedCount))

```

# Specification of the measured information (data)


## Patient contacts (and potential contact) with pharmacist

* `clinicVisits` - number of times patient physically came to the clinic
  + additional sub-categories into `clinicVisit1` and `clinicVisit2` - number of times
  the patient came to the clinic in period 1 and period 2
  + Period 1 : the twelve months before 2019-12-02 (2nd December 2019)
  + Period 2 : the nine months after 2019-12-2 (2nd December 2019), including 2nd December 2019
* `pharmacistExposure` - number of times patient physically came to the clinic on
the day the pharmacist was present.
* `DirectContact` - TRUE/FALSE - pharmacist contacted patient either in surgery
or via telephone.

```{r message=FALSE, warning=FALSE}
physical_visit_MBSItem <- c("23", "36", "3", "44", "10997", "721", "723", "732",
                            "2713", "2715", "73806", "16500", "707", "705", "2517", "2521",
                            "2525", "703", "30071", "2501", "2504")

pharmacist_dates <- read.csv("LauraDeanDays.csv") %>% pull(Date) %>% as.Date()

active_patient_inClinic <- active_patient_billings %>%
  mutate(physicalVisit = MBSItem %in% physical_visit_MBSItem) %>%
  group_by(InternalID, ServiceDate) %>% # group items on the same day/patient together
  summarise(ClinicVisit = any(physicalVisit)) %>%
  ungroup() %>%
  mutate(pharmacistDay = ClinicVisit & ServiceDate %in% pharmacist_dates)
# pharmacistDay is TRUE is patient came to clinic physically AND
#  pharmacist was present on the same day

# first day of pharmacist visit was 2019-12-02 (2nd December 2019)

ClinicExposure_df <- active_patient_inClinic %>%
  group_by(InternalID) %>%
  summarise(clinicVisits = sum(ClinicVisit),
            clinicVisit1 = sum(ClinicVisit & ServiceDate >= (as.Date("2019-12-02") - months(12)) & ServiceDate < as.Date("2019-12-02")),
            # clinicVisit1 'pre' (12 month) period before 2nd of December, the number of 'physical' visits
            clinicVisit2 = sum(ClinicVisit & ServiceDate >= as.Date("2019-12-02") & ServiceDate <= (as.Date("2019-12-02") + months(9))),
            # clinicVisit2 'post' (9 month) period after and including 2nd December, the number of 'physical' visits
            pharmacistExposure = sum(pharmacistDay)) %>%
  ungroup()

DirectContact_df <- pharmacist_contacts %>%
  group_by(InternalID) %>%
  summarise(DirectContact = any(VisitType %in% c("Surgery", "Telephone"))) %>%
  ungroup()

```

```{r}
# add the 'exposures' to the table
#  ClinicExposure - patient came on same day that pharmacist was present
#  DirectContact - pharmacist made contact with patient, either by telephone or in-person

active_patient_exposure <- active_patient %>%
  left_join(ClinicExposure_df, by = "InternalID") %>%
  left_join(DirectContact_df, by = "InternalID") %>%
  replace_na(list(DirectContact = FALSE))
```

## Medication

* Each patient has a `MedCount`.
* `MedCount` is measured at two time points `1` and `2`
  + `MedCount1` : 1st December 2019
  + `MedCount2` : 1st August 2020
* a `MedCountDelta` is calculated, subtracting the count in `1` from `2`.

```{r}
active_patient_medication <- active_patient_exposure %>%
  left_join(medication_count[[1]] %>%
              rename(MedCount1 = MedCount),
            by = "InternalID") %>%
  left_join(medication_count[[2]] %>%
              rename(MedCount2 = MedCount),
            by = "InternalID") %>%
  mutate(MedCountDelta = MedCount2 - MedCount1)
```

## Billings numbers and frequencies

The billings numbers, and frequencies, listed in declining order.

```{r}
summary(active_patient_billings$MBSItem)
```

## Billing counts

```{r}
active_patient_billings_period <- list()
active_patient_billings_period[[1]] <- active_patient_billings %>% 
  filter(ServiceDate >= (as.Date("2019-12-02") - months(12)),
         ServiceDate < (as.Date("2019-12-02")))
active_patient_billings_period[[2]] <- active_patient_billings %>%
  filter(ServiceDate >= (as.Date("2019-12-02")),
         ServiceDate < (as.Date("2019-12-02") + months(9)))
```

Grouped into `Standard`, `CDM`, `HA`, `DMMR`, `Conference`, `Nurse`

* `Standard` - 3, 23, 36, 44, 2713 etc. and telephone/telehealth equivalents
* `CDM` - 721, 723, 732 and telephone/telehealth equivalents
* `Nurse` - 10997 and telephone/telehealth equivalents
* `HA` - 701, 703, 705, 707
* `DMMR` - 900
* `Conference` - 735, 739, 743, 747, 750, 758 case conference

* `Total` - sum of all the above groups


```{r message=FALSE}
active_patient_billings_counts <- lapply(
  active_patient_billings_period,
  function(x) {
    # count the number of times each billing category occurred in each 9 month period
    x %>%
      group_by(InternalID) %>%
      summarise(Standard = sum(MBSItem %in% c("3", "23", "36", "44", "2713",
                                              "91790", "91800", "91801", "91802", "92115",
                                              "91795", "91809", "91810", "91811", "92127")),
                CDM = sum(MBSItem %in% c("721", "723", "732",
                                         "92024", "92025", "92027",
                                         "92068", "92069", "92071")),
                HA = sum(MBSItem %in% c("701", "703", "705", "707")),
                DMMR = sum(MBSItem %in% c("900")),
                Conference = sum(MBSItem %in% c("735", "739", "743",
                                                "747", "750", "758")),
                Nurse = sum(MBSItem %in% c("10997", "93201", "93203"))) %>%
      ungroup()
  }
)
```

Each billing category is counted in the two (`1` and `2`) time periods
  * Period 1 : the twelve months before 2019-12-02 (2nd December 2019)
  * Period 2 : the nine months after 2019-12-2 (2nd December 2019), including 2nd December 2019

Each billing category has a `Delta` count, calculated by subtracting 'first (`1`)'
period from the 'second (`2`)' period count. The `Delta` count can be, and often was,
negative because:

* the second time period (9 months) is shorter than the first time period (12 months)
* the second period included an extensive lock-down period  due to a coronavirus pandemic.
Resulting in both reduced access and qualitative changes in service access.

```{r}
active_patient_delta <- active_patient_medication %>%
  left_join(active_patient_billings_counts[[1]] %>%
              rename(Standard1 = Standard,
                     CDM1 = CDM,
                     HA1 = HA,
                     DMMR1 = DMMR,
                     Conference1 = Conference,
                     Nurse1 = Nurse),
            by = "InternalID") %>%
  left_join(active_patient_billings_counts[[2]] %>%
              rename(Standard2 = Standard,
                     CDM2 = CDM,
                     HA2 = HA,
                     DMMR2 = DMMR,
                     Conference2 = Conference,
                     Nurse2 = Nurse),
            by = "InternalID") %>%
  replace_na(list(Standard1 = 0, Standard2 = 0,
                  CDM1 = 0, CDM2 = 0,
                  HA1 = 0, HA2 = 0,
                  DMMR1 = 0, DMMR2 = 0,
                  Conference1 = 0, Conference2 = 0,
                  Nurse1 = 0, Nurse2 = 0)) %>%
  mutate(Total1 = Standard1 + CDM1 + HA1 + DMMR1 + Conference1 + Nurse1,
         Total2 = Standard2 + CDM2 + HA2 + DMMR2 + Conference2 + Nurse2) %>%
  filter(Total1 > 0,
         Total2 > 0) %>%
  # only patients who were billed *at least once* in BOTH period 1 AND period 2
  mutate(StandardDelta = Standard2 - Standard1,
         CDMDelta = CDM2 - CDM1,
         HADelta = HA2 - HA1,
         DMMRDelta = DMMR2 - DMMR1,
         ConferenceDelta = Conference2 - Conference1,
         NurseDelta = Nurse2 - Nurse1,
         TotalDelta = Total2 - Total1)
```

# Patient summary

Number of unique patients who have had at least had 3 billed contacts at Kensington over
the past 24 months.

(Restricted to those who have had at least one billing in the twelve months prior to
2nd December 2019, and at least one billing in the nine months after 2nd December 2019.

```{r}
nrow(active_patient_delta)
```

Number of patients who attended the clinic (physically) on the days the pharmacist was present:

```{r}
nrow(active_patient_delta %>% filter(pharmacistExposure > 0))
```

Number of patients directly contacted by pharmacist, either in person or by telephone:

```{r}
nrow(active_patient_delta %>% filter(DirectContact > 0))
```

## Number of physical visits to clinic

Period 1 - 12 month period prior to 2nd December 2019

Period 2 - 9 month period after and including 2nd December 2019

```{r}
summary(active_patient_delta %>% 
          select(clinicVisit1, clinicVisit2))
```

## Total billings (of select categories) and 'standard' billings

### 'Standard' billings 

* Item A/B/C/D, including telehealth/telephone.
* Period 1 - 12 month period prior to 2nd December 2019
* Period 2 - 9 month period after and including 2nd December 2019

```{r}
summary(active_patient_delta %>%
          select(Total1, Total2, Standard1, Standard2))

```

## Other categories

* Chronic Disease Management, Nurse (10997), Medication Review (DMMR), Case Conference and Health Assessment (HA) billings
* Period 1 - 12 month period prior to 2nd December 2019
* Period 2 - 9 month period after and including 2nd December 2019

```{r}
summary(active_patient_delta %>%
         select(CDM1, CDM2, Nurse1, Nurse2))
```

```{r}
summary(active_patient_delta %>%
          select(DMMR1, DMMR2, Conference1, Conference2, HA1, HA2))
```

# Estimations

`TotalDelta` is the difference between `Total2` (the total number of billings in
chosen categories in the second time period) and `Total1` (the total number of billings
in the first time period) : `Total2` - `Total``.

The total number of billings in the first time period `Total1` is expected to be
positively correlated with the number of physical visits in the first time period
`clinicVisit1`, and so we expect `TotalDelta` to be negatively correlated with
`clinicVisit1`. This is confirmed in plot A of Figure \@ref(fig:totaldeltavisit)
`TotalDelta` vs. `clinicVisit1`.

(ref:totaldeltavisitcaption) Change in billings vs. visits to clinic - period 1 and 2

```{r, 'totaldeltavisit', fig.cap = '(ref:totaldeltavisitcaption)', message=FALSE}
total_clinic1 <- ggplot(
  active_patient_delta,
  aes(x = clinicVisit1, y = TotalDelta)
) + geom_point() + geom_smooth(method=lm)
total_clinic2 <- ggplot(
  active_patient_delta,
  aes(x = clinicVisit2, y = TotalDelta)
) + geom_point() + geom_smooth(method=lm)
plot_grid(total_clinic1, total_clinic2,
          labels = c("A", "B"))
```

```{r}
summary(lm(TotalDelta ~ clinicVisit1, data = active_patient_delta))
```


Similarly, the total number of billings in the second time period `Total2` is expected to be
positively correlated with the number of physical visits in the second time period
`clinicVisit2`, and so we expect `TotalDelta` to be positively correlated with
`clinicVisit2`. The plot `TotalDelta` vs. `clinicVisit2` shows the relationship
is not as strong/clear as in the case of `TotalDelta` vs `clinicVisit1`, this is
due to the presence of 'non-physical' billed contacts such as tele-health/telephone
billed items.

```{r}
```

```{r}
summary(lm(TotalDelta ~ clinicVisit2, data = active_patient_delta))
```

A model predicting `TotalDelta` by combining `clinicVisit1` and `clinicVisit2`
appears to be a reasonable model.

```{r}
clinicVisit_model <- lm(TotalDelta ~ clinicVisit1 + clinicVisit2, data = active_patient_delta)
summary(clinicVisit_model)
```

```{r}
par(mfrow = c(2,2))
plot(clinicVisit_model)
```


Subsequent analysis will be aimed at determining whether contact by the practice
pharmacist influenced medications counts and billings in patients. The analysis
will be determine whether contact by the pharmacist explains any of the 'variance'
in the plots

```{r}
TotalGLM <- lm(
  TotalDelta ~ DirectContact + clinicVisit1 + clinicVisit2,
  data = active_patient_delta
)
summary(TotalGLM)
```

```{r}
StandardGLM <- lm(
  StandardDelta ~ DirectContact + clinicVisit1 + clinicVisit2,
  data = active_patient_delta
)
summary(StandardGLM)
```


```{r}
NurseGLM <- lm(
  NurseDelta ~ DirectContact + clinicVisit1 + clinicVisit2,
  data = active_patient_delta
)
summary(NurseGLM)
```
```{r}
ConferenceGLM <- lm(
  ConferenceDelta ~ DirectContact + clinicVisit1 + clinicVisit2,
  data = active_patient_delta
)
summary(ConferenceGLM)
```

```{r}
CDMGLM <- lm(
  CDMDelta ~ DirectContact + clinicVisit1 + clinicVisit2,
  data = active_patient_delta
)
summary(CDMGLM)
```

```{r}
DMMRGLM <- lm(
  DMMRDelta ~ DirectContact + clinicVisit1 + clinicVisit2,
  data = active_patient_delta
)
summary(DMMRGLM)
```

```{r}
ggplot(
  active_patient_delta,
  aes(x = clinicVisit2, y = MedCountDelta)
) + geom_point() + geom_smooth(method=lm)
```

```{r}
MedCountGLM <- lm(
  MedCountDelta ~ DirectContact + clinicVisit1 + clinicVisit2,
  data = active_patient_delta
)
summary(MedCountGLM)
```