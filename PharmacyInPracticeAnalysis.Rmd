---
title: "Pharmacy In Practice"
author: "David Fong"
date: "30/09/2020"
abstract: "Pharmacists in general practice are expected to improve medication
  efficacy and reduce medication complications and adverse effects. In order
  for pharmacists in practice to be sustainable, practice revenue needs to be
  taken into consideration. In this short study, conducted during a period of
  considerable practice and societal upheaval (December 2019 to August 2020) due
  to a coronavirus outbreak, a pharmacist in practice was able to reduce the
  overall medication count (-0.52 per patient) and increase the billings
  ('standard' +0.86, 'nursing' +0.29, 'case conference' +0.03 and 'medication
  review' +0.09) of patients the pharmacist contacted.
  <br><br>
  Additional revenue per unique patient contact is estimated
  at $90.14. One hundred and seventy unique patients were contacted, resulting in a
  total estimated revenue increase of $15323.80. Financial viability will
  require measures to ensure the pharmacist has an adequate number of patient
  contacts and measure to ensure follow-through in claimable items.
  <br><br>
  Patients who were contacted by the pharmacists were more likely to have frequent
  contacts with the practice, have more medications in their medication list and
  more likely to have been admitted to the hospital prior to the study period. These
  characteristics are associated with high risk of future admission to hospital."
output:
  bookdown::html_document2:
    toc: true
    toc_float: true
    toc_depth: 2
    code_folding: hide
---

# Introduction

General practice involves a significant, and ever increasing, number of medical
therapeutics, often prescribed to patients with increasing age and co-morbidities.
At the coHealth Kensington site, many patients also come from a background
with reduced English communication ability and overall health literacy, often
having been displaced from another country and having moved to Australia at
a mature age. coHealth Kensington is located close to areas with a high density
of public housing, sees patients who are homeless or at risk of homeless. The site
also provides mental health support, and has a high proportion of patients with
mental health conditions, including low-frequency disorders such as schizophrenia.

This is on the background of a local population which is ageing along with the
general Australian community.

The pharmacy in practice program, provided by the Primary Health Network, supported
the placement of an 'in-house' pharmacist at the Kensington site for several days
a week. The pharmacist started at the Kensington site on 2nd December 2019.

A pharmacist in practice is expected to improve medication efficacy (through
appropriate use, simplification and patient education) and reduce medication
complications (through simplification, reduced misunderstanding and review of
potential medication interactions and contra-indications). For a pharmacist
in practice to be sustainable, practice revenue needs to be taken into
consideration.

This evaluation examines whether contacts by the pharmacist with patients reduced
overall medication counts (as listed in the electronic medical record) and 
contributed to the billings/finances of the practice.

The evaluation is complicated by the effects of a coronavirus outbreak throughout
much of 2020, which severely curtailed the number of patients who physically
came to the clinic site and overall changed the way the practice operated.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r warning=FALSE, message=FALSE}
library(readxl)    # read Excel spreadsheets (with gritted teeth...)
library(summarytools)
library(magrittr)
library(dplyr)     # data pliers
library(tidyr)
library(lubridate)
library(ggplot2)   # plotting
library(cowplot)   # side-by-side plot
library(lme4)      # glmer
library(microsynth) # synthetic models
library(sjPlot)    # regression table display
library(kableExtra) # table display
```

# Sources of measurement

* The active patient list
  + generated by [dMeasure/GPstat!](https://github.com/DavidPatShuiFong/DailyMeasure), see Appendix \@ref(dMeasureCode)
  + Patients billed on three or more separate days between *2017-10-01* and *2019-09-30* inclusive
* Patient details (date of birth, age calculation)
  + generated by [PenCS CAT4](https:://www.pencs.com.au)
* The dated list of billings for patient in the 'active' list
  + generated by [dMeasure/GPstat!](https://github.com/DavidPatShuiFong/DailyMeasure)
* List of telephone and 'in-person (in surgery)' contact by the pharmacist with patients
  + generated by [dMeasure/GPstat!](https://github.com/DavidPatShuiFong/DailyMeasure)
* Medication counts of Kensington pateints *2019-12-01* and *2020-08-01*
  + generated by [PenCS CAT4](https:://www.pencs.com.au)

```{r}
### read in data

active_patient <- read.csv("active_patient.csv")
patient_details <- read_excel("Kensington20200901_all.xlsx", skip = 3)
active_patient_billings <- read.csv("active_patient_billings.csv")
pharmacist_contacts <- read.csv("LauraDeanVisits.csv")
discharge <- read.csv("KensingtonDischarge_active.csv")


# change various numericals into 'categoricals'
active_patient <- active_patient %>%
  mutate(
    InternalID = factor(InternalID)
  ) %>%
  left_join(
    patient_details %>%
      # create DOB, AgeYears (age in years as of 2/Dec/2019)
      # and AgeGroup (20 year age groups)
      select(ID, `D.O.B (Age)`) %>%
      rename(InternalID = ID) %>%
      mutate(
        DOB = as.Date(substr(`D.O.B (Age)`, 1, 10), format = "%d/%m/%Y"),
        AgeYears = as.numeric(floor(
          time_length(interval(DOB, as.Date("2019/12/02")), "years")
        ))
      ) %>%
      mutate(AgeGroup = pmax(floor(AgeYears/20), 0)) %>%
      select(InternalID, DOB, AgeYears, AgeGroup),
    by = "InternalID"
  ) %>%
  filter(!is.na(DOB)) 
# patients without DOB as of 1/Sep/2020 are actually *not* active as of
# that timepoint e.g. passed away earlier
      
# also change some date 'strings' to true 'dates'
active_patient_billings <- active_patient_billings %>%
  mutate(
    InternalID = factor(InternalID),
    MBSItem = factor(MBSItem),
    ServiceDate = as.Date(ServiceDate)
  ) %>%
  filter(Paid > 0) # only those billings which have actually been paid
# these are not truly numeric values, they are actually 'categoricals'

pharmacist_contacts <- pharmacist_contacts %>%
  mutate(
    InternalID = factor(InternalID),
    VisitType = factor(VisitType),
    VisitDate = as.Date(VisitDate)
  )

discharge <- discharge %>%
  mutate(
    InternalID = factor(InternalID),
    CorrespondenceDate = as.Date(CorrespondenceDate)
  )

medication_count <- list()
medication_count[[1]] <- read_excel(
  "PenCSMedicationCount20191201.xlsx", sheet = "ReidentifyReport",
  skip = 3) %>%
  mutate(DOB = as.Date(substr(`D.O.B (Age)`, 1, 10), format = "%d/%m/%Y"),
         Sex = factor(Sex)) %>%
  # age was not a generally useful predictor on testing
  #  it does help predict CDM and HA, but had no effect on results
  select(ID, `Med. Count`, Sex) %>%
  rename(InternalID = ID, MedCount = `Med. Count`) %>%
  mutate(InternalID = factor(InternalID), MedCount = as.numeric(MedCount))
medication_count[[2]] <- read_excel(
  "PenCSMedicationCount20200801.xlsx", sheet = "ReidentifyReport",
  skip = 3) %>%
  select(ID, `Med. Count`) %>%
  rename(InternalID = ID, MedCount = `Med. Count`) %>%
  mutate(InternalID = factor(InternalID), MedCount = as.numeric(MedCount))


```

# Specification of the measured information (data)


## Patient contacts (and potential contact) with pharmacist

* `clinicVisits` - number of times patient physically came to the clinic
  + additional sub-categories into `clinicVisit1` and `clinicVisit2` - number of times
  the patient came to the clinic in period 1 and period 2
  + Period 1 : the twelve months before 2019-12-02 (2nd December 2019)
  + Period 2 : the nine months after 2019-12-2 (2nd December 2019), including 2nd December 2019
* `pharmacistExposure` - number of times patient physically came to the clinic on
the day the pharmacist was present.
* `DirectContact` - TRUE/FALSE - pharmacist contacted patient either in surgery
or via telephone.

```{r message=FALSE, warning=FALSE}
physical_visit_MBSItem <- c("23", "36", "3", "44", "10997", "721", "723", "732",
                            "2713", "2715", "73806", "16500", "707", "705", "2517", "2521",
                            "2525", "703", "30071", "2501", "2504")

pharmacist_dates <- read.csv("LauraDeanDays.csv") %>% pull(Date) %>% as.Date()

active_patient_inClinic <- active_patient_billings %>%
  mutate(physicalVisit = MBSItem %in% physical_visit_MBSItem) %>%
  group_by(InternalID, ServiceDate) %>% # group items on the same day/patient together
  summarise(ClinicVisit = any(physicalVisit)) %>%
  ungroup() %>%
  mutate(pharmacistDay = ClinicVisit & ServiceDate %in% pharmacist_dates)
# pharmacistDay is TRUE is patient came to clinic physically AND
#  pharmacist was present on the same day

# first day of pharmacist visit was 2019-12-02 (2nd December 2019)

ClinicExposure_df <- active_patient_inClinic %>%
  group_by(InternalID) %>%
  summarise(clinicVisits = sum(ClinicVisit),
            clinicVisit1 = sum(ClinicVisit & ServiceDate >= (as.Date("2019-12-02") - months(12)) & ServiceDate < as.Date("2019-12-02")),
            # clinicVisit1 'pre' (12 month) period before 2nd of December, the number of 'physical' visits
            clinicVisit2 = sum(ClinicVisit & ServiceDate >= as.Date("2019-12-02") & ServiceDate <= (as.Date("2019-12-02") + months(9))),
            # clinicVisit2 'post' (9 month) period after and including 2nd December, the number of 'physical' visits
            pharmacistExposure = sum(pharmacistDay)) %>%
  ungroup()

DirectContact_df <- pharmacist_contacts %>%
  group_by(InternalID) %>%
  summarise(DirectContact = any(VisitType %in% c("Surgery", "Telephone"))) %>%
  ungroup()

```

```{r}
# add the 'exposures' to the table
#  ClinicExposure - patient came on same day that pharmacist was present
#  DirectContact - pharmacist made contact with patient, either by telephone or in-person

active_patient_exposure <- active_patient %>%
  left_join(ClinicExposure_df, by = "InternalID") %>%
  left_join(DirectContact_df, by = "InternalID") %>%
  replace_na(list(DirectContact = FALSE))
```

## Medication

* Each patient has a `MedCount`.
* `MedCount` is measured at two time points `1` and `2`
  + `MedCount1` : 1st December 2019
  + `MedCount2` : 1st August 2020
* a `MedCountDelta` is calculated, subtracting the count in `1` from `2`.

```{r}
active_patient_medication <- active_patient_exposure %>%
  left_join(medication_count[[1]] %>%
              rename(MedCount1 = MedCount),
            by = "InternalID") %>%
  left_join(medication_count[[2]] %>%
              rename(MedCount2 = MedCount),
            by = "InternalID") %>%
  mutate(MedCountDelta = MedCount2 - MedCount1)
```

## Discharge

* `discharges` - total number of times patient has a discharge notification
  + additional sub-categories into `discharge1` and `discharge2` - number of times
  the patient came to the clinic in period 1 and period 2
  + Period 1 : the twelve months before 2019-12-02 (2nd December 2019)
  + Period 2 : the nine months after 2019-12-2 (2nd December 2019), including 2nd December 2019

* dataframe `active_patient_discharge`
  + each `InternalID` patent has rows of weekly `row_date`s
  + `pharmacyContact` is `TRUE` if pharmacist contacted before that date
  + `admission` is `TRUE` is a discharge correspondence received just after that date.

```{r}
discharge_selection <- discharge %>%
  # just the discharge notices 12 months before or 9 months after 2/Dec/2019
  filter(CorrespondenceDate >= (as.Date("2019-12-02") - months(12)) &
           CorrespondenceDate < as.Date("2019-12-02") + months(9))
  
Discharge_df <- discharge_selection %>%
  group_by(InternalID) %>%
  summarise(discharges = n(),
            discharge1 = sum(CorrespondenceDate >= (as.Date("2019-12-02") - months(12)) & CorrespondenceDate < as.Date("2019-12-02")),
            discharge2 = sum(CorrespondenceDate >= as.Date("2019-12-02") & CorrespondenceDate < (as.Date("2019-12-02") + months(9)))
            ) %>%
  # number of discharges before 2/Dec/2019 and after 2/Dec/2019
  ungroup() %>%
  replace_na(list(discharge = 0, discharge1 = 0, discharge2 = 0))

record_dates <- seq.Date(as.Date("2019-12-02") - months(12),
                         as.Date("2019-12-02") + months(9),
                         by = "week")
# the 'recording dates' for discharges and pharmacy contacts

active_patient_discharge <- active_patient_medication %>%
  left_join(Discharge_df, by = "InternalID") %>%
  select(InternalID, clinicVisit1, clinicVisit2, Sex, MedCount1,
         discharge1, discharge2, AgeYears, AgeGroup) %>%
  replace_na(list(discharge1 = 0, discharge2 = 0,
                  MedCount1 = 0, clinicVisit1 = 0, clinicVisit2 = 0)) %>%
  mutate(row_date = list(record_dates)) %>%
  unnest(row_date) %>% # this creates a row for each of the dates (92 weeks) %>%
  mutate(admission = 0, pharmacistContact = 0)

for (i in rownames(pharmacist_contacts)) {
  if (pharmacist_contacts[i, "VisitType"] %in% c("Surgery", "Telephone")) {
    intID <- as.numeric(as.character(pharmacist_contacts[i, "InternalID"]))
    visitDate <- pharmacist_contacts[i, "VisitDate"]
    active_patient_discharge <- active_patient_discharge %>%
      mutate(pharmacistContact = if_else(
        as.numeric(as.character(InternalID)) == intID & row_date > visitDate,
        1,
        pharmacistContact))
    # marked as pharmacist contact in the week *after* the actual contact date
  }
}

for (i in rownames(discharge_selection)) {
  intID <- as.numeric(as.character(discharge_selection[i, "InternalID"]))
  admission_date <- max(record_dates[record_dates <= discharge_selection[i, "CorrespondenceDate"]])
  # choose a date *less* than the correspondence date
  active_patient_discharge <- active_patient_discharge %>%
    mutate(admission = if_else(
      as.numeric(as.character(InternalID)) == intID & row_date == admission_date,
      1,
      admission
    ))
}

active_patient_discharge <- active_patient_discharge %>% 
  mutate(timeVar = match(row_date, record_dates)) # create ranked version of dates

```

## Billings numbers and frequencies

The billings numbers, and frequencies, listed in declining order.

```{r}
summary(active_patient_billings$MBSItem)
```

## Billing counts

```{r}
active_patient_billings_period <- list()
active_patient_billings_period[[1]] <- active_patient_billings %>% 
  filter(ServiceDate >= (as.Date("2019-12-02") - months(12)),
         ServiceDate < (as.Date("2019-12-02")))
active_patient_billings_period[[2]] <- active_patient_billings %>%
  filter(ServiceDate >= (as.Date("2019-12-02")),
         ServiceDate < (as.Date("2019-12-02") + months(9)))
```

Grouped into `Standard`, `CDM`, `HA`, `DMMR`, `Conference`, `Nurse`

* `Standard` - 3, 23, 36, 44, 2713 etc. and telephone/telehealth equivalents
* `CDM` - 721, 723, 732 and telephone/telehealth equivalents
* `Nurse` - 10997 and telephone/telehealth equivalents
* `HA` - 701, 703, 705, 707
* `DMMR` - 900
* `Conference` - 735, 739, 743, 747, 750, 758 case conference

* `Total` - sum of all the above groups


```{r message=FALSE}
active_patient_billings_counts <- lapply(
  active_patient_billings_period,
  function(x) {
    # count the number of times each billing category occurred in each 9 month period
    x %>%
      group_by(InternalID) %>%
      summarise(Standard = sum(MBSItem %in% c("3", "23", "36", "44", "2713",
                                              "91790", "91800", "91801", "91802", "92115",
                                              "91795", "91809", "91810", "91811", "92127")),
                CDM = sum(MBSItem %in% c("721", "723", "732",
                                         "92024", "92025", "92027",
                                         "92068", "92069", "92071")),
                HA = sum(MBSItem %in% c("701", "703", "705", "707")),
                DMMR = sum(MBSItem %in% c("900")),
                Conference = sum(MBSItem %in% c("735", "739", "743",
                                                "747", "750", "758")),
                Nurse = sum(MBSItem %in% c("10997", "93201", "93203"))) %>%
      ungroup()
  }
)
```

Each billing category is counted in the two (`1` and `2`) time periods
  * Period 1 : the twelve months before 2019-12-02 (2nd December 2019)
  * Period 2 : the nine months after 2019-12-2 (2nd December 2019), including 2nd December 2019

Each billing category has a `Delta` count, calculated by subtracting 'first (`1`)'
period from the 'second (`2`)' period count. The `Delta` count can be, and often was,
negative because:

* the second time period (9 months) is shorter than the first time period (12 months)
* the second period included an extensive lock-down period  due to a coronavirus pandemic.
Resulting in both reduced access and qualitative changes in service access.

```{r}
active_patient_delta <- active_patient_medication %>%
  left_join(active_patient_billings_counts[[1]] %>%
              rename(Standard1 = Standard,
                     CDM1 = CDM,
                     HA1 = HA,
                     DMMR1 = DMMR,
                     Conference1 = Conference,
                     Nurse1 = Nurse),
            by = "InternalID") %>%
  left_join(active_patient_billings_counts[[2]] %>%
              rename(Standard2 = Standard,
                     CDM2 = CDM,
                     HA2 = HA,
                     DMMR2 = DMMR,
                     Conference2 = Conference,
                     Nurse2 = Nurse),
            by = "InternalID") %>%
  replace_na(list(Standard1 = 0, Standard2 = 0,
                  CDM1 = 0, CDM2 = 0,
                  HA1 = 0, HA2 = 0,
                  DMMR1 = 0, DMMR2 = 0,
                  Conference1 = 0, Conference2 = 0,
                  Nurse1 = 0, Nurse2 = 0)) %>%
  mutate(Total1 = Standard1 + CDM1 + HA1 + DMMR1 + Conference1 + Nurse1,
         Total2 = Standard2 + CDM2 + HA2 + DMMR2 + Conference2 + Nurse2) %>%
  filter(Total1 > 0,
         Total2 > 0) %>%
  # only patients who were billed *at least once* in BOTH period 1 AND period 2
  mutate(StandardDelta = Standard2 - Standard1,
         CDMDelta = CDM2 - CDM1,
         HADelta = HA2 - HA1,
         DMMRDelta = DMMR2 - DMMR1,
         ConferenceDelta = Conference2 - Conference1,
         NurseDelta = Nurse2 - Nurse1,
         TotalDelta = Total2 - Total1)
```

# Patient summary

Number of unique patients who have had at least had 3 billed contacts at Kensington over
the past 24 months.

(Restricted to those who have had at least one billing in the twelve months prior to
2nd December 2019, and at least one billing in the nine months after 2nd December 2019.

```{r}
nrow(active_patient_delta)
```

Number of patients who attended the clinic (physically) on the days the pharmacist was present:

```{r}
nrow(active_patient_delta %>% filter(pharmacistExposure > 0))
```

Number of patients directly contacted by pharmacist, either in person or by telephone:

```{r}
nrow(active_patient_delta %>% filter(DirectContact > 0))
```

## Number of physical visits to clinic

Period 1 - 12 month period prior to 2nd December 2019

Period 2 - 9 month period after and including 2nd December 2019

```{r warning=FALSE, message=FALSE, results="asis"}
descr(active_patient_delta %>% 
        select(clinicVisit1, clinicVisit2),
      stats = c("mean", "sd", "min", "q1", "med", "q3", "max"),
      style = "rmarkdown", headings = FALSE
)
```

## Hospital admissions and discharges

Hospital admissions and discharges in period 2 (2nd December 2019 to 2nd September 2020) are
positively correlated with the number of admissions and discharges in period 1
(the twelve months before 2nd December 2019), the number of clinic visits in period 1,
the number of medications in the patient list in period 1 and male sex.

Number of admissions is also related to the 'age group'. In the model below,
age groups are twenty year age groups, starting at age zero years.


```{r}
discharge_model <- lm(
  discharge2 ~ discharge1 + clinicVisit1 + MedCount1 + factor(AgeGroup) + Sex,
  data = active_patient_discharge
)
tab_model(discharge_model)
```

## Billings (of select categories) 

### 'Total' billings (of all selected categories)

```{r warning=FALSE, message=FALSE, results="asis"}
descr(active_patient_delta %>%
          select(Total1, Total2),
      stats = c("mean", "sd", "min", "q1", "med", "q3", "max"),
      style = "rmarkdown", headings = FALSE
)
```

### 'Standard' billings 

* Item A/B/C/D, including telehealth/telephone.
* Period 1 - 12 month period prior to 2nd December 2019
* Period 2 - 9 month period after and including 2nd December 2019

```{r warning=FALSE, message=FALSE, results="asis"}
descr(active_patient_delta %>%
          select(Standard1, Standard2),
      stats = c("mean", "sd", "min", "q1", "med", "q3", "max"),
      style = "rmarkdown", headings = FALSE
)
```

### Other categories

* Chronic Disease Management, Nurse (10997), Medication Review (DMMR), Case Conference and Health Assessment (HA) billings
* Period 1 - 12 month period prior to 2nd December 2019
* Period 2 - 9 month period after and including 2nd December 2019

```{r warning=FALSE, message=FALSE, results="asis"}
descr(active_patient_delta %>%
         select(CDM1, CDM2, Nurse1, Nurse2),
      stats = c("mean", "sd", "min", "q1", "med", "q3", "max"),
      style = "rmarkdown", headings = FALSE
)
```


```{r warning=FALSE, message=FALSE, results="asis", error=FALSE}
descr(x = (active_patient_delta %>%
             select(DMMR1, DMMR2, Conference1, Conference2, HA1, HA2)),
      stats = c("mean", "sd", "min", "q1", "med", "q3", "max"),
      style = "rmarkdown", headings = FALSE
)
```

# Estimations

The overall approach is a 'difference-in-difference' estimation.

* compare the medication count and billings of patients in the time period
when the pharmacist was working at the Kensington site (time period `2`),
with the same patients who were also seen at the clinic prior to the pharmacist
commencing (time period `1`).
* `Sex` is also a (weak) predictor, and is included in the baseline model. 
* Some, but not all, of these same patients were *also* were contacted by the
pharmacist, either in person or by telephone.

### Analysis method

The choice of baseline model is described in Appendix \@ref(baselinemodel).

Subsequent analysis will be aimed at determining whether contact by the practice
pharmacist influenced medications counts and billings in patients. The analysis
will be determine whether contact by the pharmacist explains any of the 'variance'
not explained in the 'baseline model' described in Appendix \@ref(baselinemodel).

## Medication count

Contact by the pharmacist with a patient is strongly related to reduction in
medication count (95% confidence interval -0.82 to -0.21, $p=0.001$).

```{r}
MedCountGLM_base <- lm(
  MedCountDelta ~ clinicVisit1 + clinicVisit2 + Sex,
  data = active_patient_delta
)
MedCountGLM <- lm(
  MedCountDelta ~ DirectContact + clinicVisit1 + clinicVisit2 + Sex,
  data = active_patient_delta
)
tab_model(MedCountGLM_base, MedCountGLM)
```

## Hospital admissions and discharge

The number of times a patient is seen in the clinic in time period 1 or 2,
the number of medications and the number of admissions in time period 1 all
are positively correlated with whether the patient was contacted/seen by the
pharmacist in time period 2.

This suggests that the pharmacist was seeing patients who are at high risk,
including at high risk of (re-)admission to hospital.

```{r message = FALSE}
seen_by_pharmacist_model <- lm(
  pharmacistContact ~ clinicVisit1 + clinicVisit2 + MedCount1 + discharge1,
  data = active_patient_discharge
)
tab_model(seen_by_pharmacist_model, digits = 4)
```

<br>

Even when comparing with 'synthetic controls', the patients seen by the pharmacist
appear to be at high risk of being admitted to hospital.

The 'synthetic' controls are matched to patients seen by the pharmacist by
the number of clinic visits in time period 1 and 2, the number of medications
in the medication list at the end of time period 1, sex and age group (twenty
year strata).

In the plots below, 'week 53' (indicated by a red dashed line) shows when the pharmacist
contacted the patient. On visual inspection, there appears to be in a slight rise
in the number of (pharmacist contact) 'treatment' patients being admitted to hospital
when compared to the synthetic controls (right plot), even prior to week 53 (time 
of contact with the pharmacist).

```{r message=FALSE}
df <- active_patient_discharge %>%
  filter(!is.na(Sex)) %>%
  mutate(Sex = dplyr::if_else(Sex == "F", 0, 1)) %>%
  as.data.frame(stringsasFactor = FALSE)

cov.var <- c("clinicVisit1", "clinicVisit2", "MedCount1", "Sex", "AgeGroup")

discharge_synth <- microsynth(data = df,
                              idvar = "InternalID", timevar = "timeVar",
                              intvar = "pharmacistContact",
                              match.out = list("admission" = c(2, 8, 8, 8)),
                              match.covar.min = cov.var,
                              result.var = "admission", omnibus.var = "admission",
                              n.cores = 1)
plot_microsynth(discharge_synth, main.diff = "admission trend vs control", xlab.tc = "weeks", xlab.diff = "weeks")
```

## Billings

### Total Billings and contact with pharmacist

Contact by the pharmacist with a patient is strongly related to additional Medicare
billings in the selected categories (95% confidence interval 0.70 to 1.58 additional
billings per patient, $p<0.001$).

```{r}
TotalGLM_base <- lm(
  TotalDelta ~ clinicVisit1 + clinicVisit2 + Sex,
  data = active_patient_delta
)
TotalGLM <- lm(
  TotalDelta ~ DirectContact + clinicVisit1 + clinicVisit2 + Sex,
  data = active_patient_delta
)
tab_model(TotalGLM_base, TotalGLM)
```

### 'Standard' billings and contact with the pharmacist

Contact by the pharmacist with a patient is strongly related to additional 'standard'
Medicare item number billings (95% confidence interval 0.48 to 1.25 additional billings
per patient, $p<0.001$)

```{r}
StandardGLM_base <- lm(
  StandardDelta ~ clinicVisit1 + clinicVisit2 + Sex,
  data = active_patient_delta
)
StandardGLM <- lm(
  StandardDelta ~ DirectContact + clinicVisit1 + clinicVisit2 + Sex,
  data = active_patient_delta
)
tab_model(StandardGLM_base, StandardGLM)
```

### Nurse provision of services related to chronic disease management

Contact by the pharmacist with a patient is strongly related to additional nurse
chronic disease management item number billings (95% confidence interval 0.12
to 0.46, $p=0.001$).

```{r}
NurseGLM_base <- lm(
  NurseDelta ~ clinicVisit1 + clinicVisit2 + Sex,
  data = active_patient_delta
)
NurseGLM <- lm(
  NurseDelta ~ DirectContact + clinicVisit1 + clinicVisit2 + Sex,
  data = active_patient_delta
)
tab_model(NurseGLM_base, NurseGLM)
```

### Case conference item numbers

Contact by the pharmacist with a patient is weakly related to additional case conference
item number claims (95% confidence interval -0.01 to 0.08, $p=0.136$).

```{r}
ConferenceGLM_base <- lm(
  ConferenceDelta ~ clinicVisit1 + clinicVisit2 + Sex,
  data = active_patient_delta
)
ConferenceGLM <- lm(
  ConferenceDelta ~ DirectContact + clinicVisit1 + clinicVisit2 + Sex,
  data = active_patient_delta
)
tab_model(ConferenceGLM_base, ConferenceGLM)
```

### Domiciliary 'Home' medication reviews

Contact by a pharmacist with a patient is strongly related to home medication review
claims (95% confidence interval 0.07 to 0.11, $p<0.001$)

```{r}
DMMRGLM_base <- lm(
  DMMRDelta ~ clinicVisit1 + clinicVisit2 + Sex,
  data = active_patient_delta
)
DMMRGLM <- lm(
  DMMRDelta ~ DirectContact + clinicVisit1 + clinicVisit2 + Sex,
  data = active_patient_delta
)
tab_model(DMMRGLM_base, DMMRGLM)
```

# Summary and Conclusion

During a period (December 2019 to August 2020) of considerable societal and medical
practice upheaval due to a coronavirus outbreak, a pharmacist in practice was able
to reduce the overall medication count (-0.52 per patient) and increase the billings
('standard' +0.86, 'nursing' +0.29, 'case conference' +0.04 and 'medication review'
+0.09) of patients the pharmacist contacted.

Additional revenue per unique patient contact is estimated at $89.73 (Appendix \@ref(revenueEstimates)).
One hundred and seventy unique patients were contacted, resulting in a total
estimated revenue increase of $15254.10.

Although a pharmacist in practice was expected to reduce the medication count and
increase the number of medication reviews, case conferences and perhaps other chronic
disease management activities, the increase in other primary care team activity
('standard' item numbers, and 'nurse' related chronic disease management items) was
even more pronounced. This perhaps is because the pharmacist played a role
inside a primary care team, and the pharmacist's interaction with the patient
resulted in subsequent intentional activity with other primary care team members.

Although there was significant benefit, both medical and financial, with each
pharmacist interaction with a patient, there was an overall struggle to arrange
such an interaction in the first place. Initial plans to create these interactions,
ranging from asthma plans and device training, screening for non-urgent review
of chronic disease and daily screening of patient appointment lists for patients
with polypharmacy were severely impacted by a global pandemic of a respiratory
illness which resulted in far fewer patients willing to come physically to the clinic,
or stay in the clinic for longer periods of time.

Only fairly late in the trial were programs successfully implemented to recruit
patients to see the pharmacist without requiring initial physical presence in
the clinic e.g. review of incoming and filed discharge correspondence.

Success of future pharmacy in practice programs will rely not only on the great
medical and financial value which each interaction brings, but also attention
to arranging such interactions and improved follow-through on potential
medication review and care planning opportunities.

# (APPENDIX) Appendix {-}

# Baseline model {#baselinemodel}

The baseline model estimates the number of billings (in select categories) a patient
will have in the second period (after 2nd December 2020) based on the billings in
the first period (prior to 2nd December 2020). The model bases the prediction on
the number of times the patient visits the practice in-person (i.e. not telehealth
or telephone consult).

Visits to the practice are used as a predictor, as this is also expected to be
correlated to contact with the in-practice pharmacist. Until fairly late in the
trial, strategies for patients to have a consult with the pharmacist mainly depended
on patients physically in the practice being introduced (physically) to the pharmacist.

### Billing change, baseline model

`TotalDelta` is the difference between `Total2` (the total number of billings in
chosen categories in the second time period) and `Total1` (the total number of billings
in the first time period) : `Total2` - `Total1`.

The total number of billings in the first time period `Total1` is expected to be
positively correlated with the number of physical visits in the first time period
`clinicVisit1`, and so we expect `TotalDelta` to be negatively correlated with
`clinicVisit1`. This is confirmed in plot A of Figure \@ref(fig:totaldeltavisit)
`TotalDelta` vs. `clinicVisit1`.

(ref:totaldeltavisitcaption) Change in billings vs. visits to clinic - period 1 and 2

```{r, 'totaldeltavisit', fig.cap = '(ref:totaldeltavisitcaption)', message=FALSE, warning=FALSE}
total_clinic1 <- ggplot(
  active_patient_delta,
  aes(x = clinicVisit1, y = TotalDelta)
) + geom_point() + geom_smooth(method=lm)
total_clinic2 <- ggplot(
  active_patient_delta,
  aes(x = clinicVisit2, y = TotalDelta)
) + geom_point() + geom_smooth(method=lm)
cowplot::plot_grid(total_clinic1, total_clinic2,
                   labels = c("A", "B"))
```

Similarly, the total number of billings in the second time period `Total2` is expected to be
positively correlated with the number of physical visits in the second time period
`clinicVisit2`. So it is expected `TotalDelta` will be positively correlated with
`clinicVisit2`. Plot B of Figure \@ref(fig:totaldeltavisit) '`TotalDelta` vs. `clinicVisit2`'
shows the relationship is not as strong/clear as in the case of `TotalDelta` vs `clinicVisit1`.
This is most likely due to the presence of 'non-physical' billed contacts such as
tele-health/telephone billed items.

Adding `Sex` to the model is of weak benefit. Adding `DOB` (date of birth) to the
model did not provide any additional benefit.

```{r}
clinicVisit1_model <- lm(TotalDelta ~ clinicVisit1, data = active_patient_delta)
clinicVisit2_model <- lm(TotalDelta ~ clinicVisit2, data = active_patient_delta)
clinicVisitBoth_model <- lm(TotalDelta ~ clinicVisit1 + clinicVisit2, data = active_patient_delta)
clinicVisitBothSex_model <- lm(TotalDelta ~ clinicVisit1 + clinicVisit2 + Sex, data = active_patient_delta)
tab_model(clinicVisit1_model, clinicVisit2_model, clinicVisitBoth_model, clinicVisitBothSex_model)
```

<br>

A model predicting `TotalDelta` by combining `clinicVisit1`, `clinicVisit2` and `Sex`
appears to be a reasonable model. Residuals of this model are shown in
Figure \@ref(fig:totaldeltavisitresidual)

(ref:totaldeltavisitresidualcaption) Residuals of 'TotalDelta ~ clinicVisit1 + clinicVisit2 + Sex' model

```{r, 'totaldeltavisitresidual', fig.cap = '(ref:totaldeltavisitresidualcaption)', message=FALSE}
par(mfrow = c(2,2))
plot(clinicVisitBothSex_model)
```

### Medication count change, baseline model

A similar model is build for changes in medication count `MedCountDelta`, depending
on the number of physical visits in the two time periods (`clinicVisit1` and `clinicVisit2`).

`clinicVisit1` and `clinicVisit2` do help predict `MedCountDelta`, but the relationship
is not as strongs as for billings.

(ref:medcountdeltavisitcaption) Change in medication count vs. visits to clinic - period 1 and 2

```{r, 'medcountdeltavisit', fig.cap='(ref:medcountdeltavisitcaption)', message=FALSE, warning=FALSE}
medcount_clinic1 <- ggplot(
  active_patient_delta,
  aes(x = clinicVisit1, y = MedCountDelta)
) + geom_point() + geom_smooth(method=lm)
medcount_clinic2 <- ggplot(
  active_patient_delta,
  aes(x = clinicVisit2, y = MedCountDelta)
) + geom_point() + geom_smooth(method=lm)
cowplot::plot_grid(medcount_clinic1, medcount_clinic2,
                   labels = c("A", "B"))
```

```{r}
medcount_clinicVisit1_model <- lm(MedCountDelta ~ clinicVisit1,
                                  data = active_patient_delta)
medcount_clinicVisit2_model <- lm(MedCountDelta ~ clinicVisit2,
                                  data = active_patient_delta)
medcount_clinicVisitBoth_model <- lm(MedCountDelta ~ clinicVisit1 + clinicVisit2,
                                     data = active_patient_delta)
medcount_clinicVisitBothSex_model <- lm(MedCountDelta ~ clinicVisit1 + clinicVisit2 + Sex,
                                        data = active_patient_delta)
tab_model(medcount_clinicVisit1_model, medcount_clinicVisit2_model,
          medcount_clinicVisitBoth_model, medcount_clinicVisitBothSex_model)
```

(ref:medndeltavisitresidualcaption) Residuals of 'MedCountDelta ~ clinicVisit1 + clinicVisit2 + Sex' model

```{r, 'medndeltavisitresidual', fig.cap = '(ref:medndeltavisitresidualcaption)', message=FALSE}
par(mfrow = c(2,2))
plot(medcount_clinicVisitBothSex_model)
```

# Detailed revenue estimates {#revenueEstimates}

```{r message=FALSE}
active_patient_billings_counts_specifics <- lapply(
  active_patient_billings_period,
  function(x) {
    # count the number of times each billing category occurred in each 9 month period
    x %>%
      group_by(InternalID) %>%
      summarise(StandardA = sum(MBSItem %in% c("3", "91790", "91795")),
                StandardB = sum(MBSItem %in% c("23", "91800", "91809")),
                StandardC = sum(MBSItem %in% c("36", "91801", "91810")),
                StandardD = sum(MBSItem %in% c("44", "91802", "91811")),
                StandardMH = sum(MBSItem %in% c("2713", "92115", "92127")),
                BBIncentive = sum(MBSItem %in% c("10990")),
                CDM721 = sum(MBSItem %in% c("721", "92024", "92068")),
                CDM723 = sum(MBSItem %in% c("723", "92025", "92069")),
                CDM732 = sum(MBSItem %in% c("732", "92028", "92072")),
                Conference735 = sum(MBSItem %in% c("735")),
                Conference739 = sum(MBSItem %in% c("739")),
                Conference743 = sum(MBSItem %in% c("743")),
                Conference747 = sum(MBSItem %in% c("747")),
                Conference750 = sum(MBSItem %in% c("750")),
                Conference758 = sum(MBSItem %in% c("758"))) %>%
      ungroup()           
    }
)
C
active_patient_delta_specifics <- active_patient_delta %>%
  left_join(active_patient_billings_counts_specifics[[1]] %>%
              rename(StandardA1 = StandardA,
                     StandardB1 = StandardB,
                     StandardC1 = StandardC,
                     StandardD1 = StandardD,
                     StandardMH1 = StandardMH,
                     BBIncentive1 = BBIncentive,
                     CDM721_1 = CDM721,
                     CDM723_1 = CDM723,
                     CDM732_1 = CDM732,
                     Conference735_1 = Conference735,
                     Conference739_1 = Conference739,
                     Conference743_1 = Conference743,
                     Conference747_1 = Conference747,
                     Conference750_1 = Conference750,
                     Conference758_1 = Conference758),
            by = "InternalID") %>%
  left_join(active_patient_billings_counts_specifics[[2]] %>%
              rename(StandardA2 = StandardA,
                     StandardB2 = StandardB,
                     StandardC2 = StandardC,
                     StandardD2 = StandardD,
                     StandardMH2 = StandardMH,
                     BBIncentive2 = BBIncentive,
                     CDM721_2 = CDM721,
                     CDM723_2 = CDM723,
                     CDM732_2 = CDM732,
                     Conference735_2 = Conference735,
                     Conference739_2 = Conference739,
                     Conference743_2 = Conference743,
                     Conference747_2 = Conference747,
                     Conference750_2 = Conference750,
                     Conference758_2 = Conference758),
            by = "InternalID") %>%
  replace_na(list(StandardA1 = 0, StandardA2 = 0,
                  StandardB1 = 0, StandardB2 = 0,
                  StandardC1 = 0, StandardC2 = 0,
                  StandardD1 = 0, StandardD2 = 0,
                  StandardMH1 = 0, StandardMH2 = 0,
                  BBIncentive1 = 0, BBIncentive2 = 0,
                  CDM721_1 = 0, CDM721_2 = 0,
                  CDM723_1 = 0, CDM723_2 = 0,
                  CDM732_1 = 0, CDM732_2 = 0,
                  Conference735_1 = 0, Confernece735_2 = 0,
                  Conference739_1 = 0, Confernece739_2 = 0,
                  Conference743_1 = 0, Confernece743_2 = 0,
                  Conference747_1 = 0, Confernece747_2 = 0,
                  Conference750_1 = 0, Confernece750_2 = 0,
                  Conference758_1 = 0, Confernece758_2 = 0)) %>%
  mutate(StandardADelta = StandardA2 - StandardA1,
         StandardBDelta = StandardB2 - StandardB1,
         StandardCDelta = StandardC2 - StandardC1,
         StandardDDelta = StandardD2 - StandardD1,
         BBIncentiveDelta = BBIncentive2 - BBIncentive1,
         CDM721Delta = CDM721_2 - CDM721_1,
         CDM723Delta = CDM723_2 - CDM723_1,
         CDM732Delta = CDM732_2 - CDM732_1,
         Conference735Delta = Conference735_2 - Conference735_1,
         Conference739Delta = Conference739_2 - Conference739_1,
         Conference743Delta = Conference743_2 - Conference743_1,
         Conference747Delta = Conference747_2 - Conference747_1,
         Conference750Delta = Conference750_2 - Conference750_1,
         Conference758Delta = Conference758_2 - Conference758_1)
```

## 'Standard' item numbers

```{r}
StandardAGLM <- lm(
  StandardADelta ~ DirectContact + clinicVisit1 + clinicVisit2 + Sex,
  data = active_patient_delta_specifics
)
StandardBGLM <- lm(
  StandardBDelta ~ DirectContact + clinicVisit1 + clinicVisit2 + Sex,
  data = active_patient_delta_specifics
)
StandardCGLM <- lm(
  StandardCDelta ~ DirectContact + clinicVisit1 + clinicVisit2 + Sex,
  data = active_patient_delta_specifics
)
StandardDGLM <- lm(
  StandardDDelta ~ DirectContact + clinicVisit1 + clinicVisit2 + Sex,
  data = active_patient_delta_specifics
)
tab_model(StandardAGLM, StandardBGLM, StandardCGLM, StandardDGLM)
```


## Bulk-bill incentives

```{r}
BBIncentiveGLM <- lm(
  BBIncentiveDelta ~ DirectContact + clinicVisit1 + clinicVisit2 + Sex,
  data = active_patient_delta_specifics
)
tab_model(BBIncentiveGLM)
```

## Case conference

```{r}
Conference735GLM <- lm(
  Conference735Delta ~ DirectContact + clinicVisit1 + clinicVisit2 + Sex,
  data = active_patient_delta_specifics
)
Conference739GLM <- lm(
  Conference739Delta ~ DirectContact + clinicVisit1 + clinicVisit2 + Sex,
  data = active_patient_delta_specifics
)
Conference743GLM <- lm(
  Conference743Delta ~ DirectContact + clinicVisit1 + clinicVisit2 + Sex,
  data = active_patient_delta_specifics
)
tab_model(Conference735GLM, Conference739GLM, Conference743GLM)
```

```{r}
Conference747GLM <- lm(
  Conference747Delta ~ DirectContact + clinicVisit1 + clinicVisit2 + Sex,
  data = active_patient_delta_specifics
)
Conference750GLM <- lm(
  Conference750Delta ~ DirectContact + clinicVisit1 + clinicVisit2 + Sex,
  data = active_patient_delta_specifics
)
Conference758GLM <- lm(
  Conference758Delta ~ DirectContact + clinicVisit1 + clinicVisit2 + Sex,
  data = active_patient_delta_specifics
)
tab_model(Conference747GLM, Conference750GLM, Conference758GLM)
```

## Totals

Estimated 'Delta' is *per patient* contacted.

```{r results='asis'}
tabulated_revenue <- data.frame(Item = character(), Delta = numeric(), ValuePerItem = numeric()) %>%
  add_row(Item = "A 'Item 3'", Delta = StandardAGLM$coefficients["DirectContactTRUE"], ValuePerItem = 17.75) %>%
  add_row(Item = "B 'Item 23'", Delta = StandardBGLM$coefficients["DirectContactTRUE"], ValuePerItem = 38.75) %>%
  add_row(Item = "C 'Item 36'", Delta = StandardCGLM$coefficients["DirectContactTRUE"], ValuePerItem = 75.05) %>%
  add_row(Item = "D 'Item 44'", Delta = StandardDGLM$coefficients["DirectContactTRUE"], ValuePerItem = 110.50) %>%
  add_row(Item = "BB Incentive '10990'", Delta = BBIncentiveGLM$coefficients["DirectContactTRUE"], ValuePerItem = 12.95) %>%
  add_row(Item = "Nurse CDM '10997'", Delta = NurseGLM$coefficients["DirectContactTRUE"], ValuePerItem = 12.40) %>%
  add_row(Item = "DMMR", Delta = DMMRGLM$coefficients["DirectContactTRUE"], ValuePerItem = 159.65) %>%
  add_row(Item = "Conference 735", Delta = Conference735GLM$coefficients["DirectContactTRUE"], ValuePerItem = 72.90) %>%
  add_row(Item = "Conference 739", Delta = Conference739GLM$coefficients["DirectContactTRUE"], ValuePerItem = 124.75) %>%
  add_row(Item = "Conference 743", Delta = Conference743GLM$coefficients["DirectContactTRUE"], ValuePerItem = 207.95) %>%
  add_row(Item = "Conference 747", Delta = Conference747GLM$coefficients["DirectContactTRUE"], ValuePerItem = 53.55) %>%
  add_row(Item = "Conference 750", Delta = Conference750GLM$coefficients["DirectContactTRUE"], ValuePerItem = 91.75) %>%
  add_row(Item = "Conference 758", Delta = Conference758GLM$coefficients["DirectContactTRUE"], ValuePerItem = 152.80) %>%
  mutate(TotalValue = Delta * ValuePerItem)
  
kable(tabulated_revenue, digits = 3) %>%
  kable_styling(bootstrap_options = c("striped"))
```

Total additional revenue per patient contacted : $`r format(round(sum(tabulated_revenue$TotalValue), digits = 2))`

# Data extraction using [dMeasure/GPstat](https://github.com/DavidPatShuiFong/DailyMeasure) {#dMeasureCode}

```{r class.source="fold-show", eval=FALSE}
library(pipeR)
library(dplyr)
library(dMeasure)

a <- dMeasure::dMeasure$new()
a$open_emr_db()
## active patients
kensington_clinicians <- a$UserConfig %>>%
  filter(
    grepl(
      "Kensington",
      purrr::map_chr(Location, function(x) paste(x, collapse = ", "))
      # map_chr will create a 'collapsed' version of all the
      # listed locations
    )
  )

active_patient <- a$list_contact_count(
  date_from = as.Date("2017-10-01"), date_to = as.Date("2019-09-30"),
  clinicians = kensington_clinicians$Fullname,
  min_contact = 3,
  contact_type = "Services",
  lazy = FALSE, store = FALSE
)

active_patient_ID <- active_patient %>>% dplyr::pull(InternalID)

active_patient_billings <- a$emr_db$conn() %>>%
  tbl("SERVICES") %>>%
  select("SERVICEID", "SERVICEDATE", "INVOICEID", "MBSITEM", "PAID", "DESCRIPTION") %>>%
  filter(INVOICEID %in% invoiceID,
         as.Date(ServiceDate) >= as.Date("2017-10-01")) %>>%
  collect() %>>%
  rename(InvoiceID = INVOICEID, ServiceDate = SERVICEDATE,
         MBSItem = MBSITEM, Paid = PAID, Description = DESCRIPTION ) %>>%
  mutate(Description = trimws(Description),
         ServiceDate = as.Date(ServiceDate)) %>>%
  left_join(invoices %>>% collect(),
            by = "InvoiceID")

#active_patient_billings <- a$db$services %>>%
#  filter(
#    InternalID %in% active_patient_ID,
#    ServiceDate >= as.Date("2017-10-01")
#  ) %>>% dplyr::collect()

LauraDeanVisits <- a$db$visits %>% filter(DrName == "Laura Dean")
# InternalID, VisitType, VisitDate, UserID, DrName
```
